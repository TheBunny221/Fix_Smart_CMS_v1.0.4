// NLC-CMS Complaint Management System
// Unified Prisma Schema for PostgreSQL
// Version:  1.0.0 - Production Ready

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ============================================================================
// ENUMS - Type-safe status and role definitions
// ============================================================================

enum UserRole {
  CITIZEN
  WARD_OFFICER
  MAINTENANCE_TEAM
  ADMINISTRATOR
  GUEST
}

enum ComplaintStatus {
  REGISTERED
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REOPENED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SLAStatus {
  ON_TIME
  WARNING
  OVERDUE
  COMPLETED
}

enum AttachmentEntityType {
  COMPLAINT
  CITIZEN
  USER
  MAINTENANCE_PHOTO
}

// ============================================================================
// CORE MODELS - Main entities of the system
// ============================================================================

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  fullName    String
  phoneNumber String?
  password    String?
  role        UserRole  @default(CITIZEN)
  wardId      String?
  department  String?
  language    String    @default("en")
  avatar      String?
  isActive    Boolean   @default(true)
  lastLogin   DateTime?
  joinedOn    DateTime  @default(now())

  // Relations - Only active models
  ward                      Ward?          @relation(fields: [wardId], references: [id])
  submittedComplaints       Complaint[]    @relation("SubmittedBy")
  assignedComplaints        Complaint[]    @relation("AssignedTo")
  wardOfficerComplaints     Complaint[]    @relation("WardOfficer")
  maintenanceTeamComplaints Complaint[]    @relation("MaintenanceTeam")
  statusLogs                StatusLog[]
  otpSessions               OTPSession[]
  uploadedAttachments       Attachment[]   @relation("AttachmentUploadedBy")
  notifications             Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role, isActive])
  @@index([wardId])
  @@index([email])
  @@map("users")
}

model Ward {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  // Relations - Only active models
  users      User[]
  complaints Complaint[]
  subZones   SubZone[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
  @@map("wards")
}

model SubZone {
  id          String  @id @default(cuid())
  name        String
  wardId      String
  description String?
  isActive    Boolean @default(true)

  // Relations
  ward       Ward        @relation(fields: [wardId], references: [id], onDelete: Cascade)
  complaints Complaint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([wardId])
  @@index([name])
  @@map("sub_zones")
}

model ComplaintType {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  priority    Priority    @default(MEDIUM)
  slaHours    Int         @default(48)
  isActive    Boolean     @default(true)
  complaints  Complaint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
  @@map("complaint_types")
}

// ============================================================================
// COMPLAINT MANAGEMENT - Core complaint handling
// ============================================================================

model Complaint {
  id              String          @id @default(cuid())
  complaintId     String?         @unique // Human-readable complaint ID like KSC0001
  title           String?
  description     String
  // Legacy string type retained for backward compatibility
  type            String?
  complaintTypeId Int?
  status          ComplaintStatus @default(REGISTERED)
  priority        Priority        @default(MEDIUM)
  slaStatus       SLAStatus       @default(ON_TIME)

  // Location Information
  wardId      String
  subZoneId   String?
  area        String
  landmark    String?
  address     String?
  coordinates String? // JSON string for lat/lng
  latitude    Float? // Explicit latitude field
  longitude   Float? // Explicit longitude field

  // Contact Information
  contactName  String?
  contactEmail String?
  contactPhone String
  isAnonymous  Boolean @default(false)

  // Assignment and Tracking
  submittedById     String?
  assignedToId      String? // Generic assignment field (kept for backward compatibility)
  resolvedById      String?
  wardOfficerId     String? // Automatically assigned ward officer
  maintenanceTeamId String? // Assigned maintenance team member

  // Timestamps
  submittedOn DateTime  @default(now())
  assignedOn  DateTime?
  resolvedOn  DateTime?
  closedOn    DateTime?
  deadline    DateTime?

  // Additional Information
  remarks         String?
  citizenFeedback String?
  rating          Int? // 1-5 rating
  assignToTeam    Boolean @default(false) // Team assignment flag
  tags            String? // JSON array of tags

  // Relations - Only active models
  ward            Ward           @relation(fields: [wardId], references: [id])
  subZone         SubZone?       @relation(fields: [subZoneId], references: [id])
  submittedBy     User?          @relation("SubmittedBy", fields: [submittedById], references: [id])
  assignedTo      User?          @relation("AssignedTo", fields: [assignedToId], references: [id])
  wardOfficer     User?          @relation("WardOfficer", fields: [wardOfficerId], references: [id])
  maintenanceTeam User?          @relation("MaintenanceTeam", fields: [maintenanceTeamId], references: [id])
  complaintType   ComplaintType? @relation(fields: [complaintTypeId], references: [id])
  statusLogs      StatusLog[]
  attachments     Attachment[]
  notifications   Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([submittedById, createdAt])
  @@index([wardId, status])
  @@index([assignedToId, status])
  @@index([maintenanceTeamId, status])
  @@index([type, status])
  @@index([complaintTypeId, status])
  @@index([priority, status])
  @@index([submittedOn])
  @@index([status, createdAt])
  @@index([complaintId])
  @@map("complaints")
}

model StatusLog {
  id          String   @id @default(cuid())
  complaintId String
  userId      String
  fromStatus  String? // Previous status
  toStatus    String // New status
  comment     String?
  timestamp   DateTime @default(now())

  // Relations
  complaint Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([complaintId, timestamp])
  @@index([userId])
  @@index([timestamp])
  @@map("status_logs")
}

// ============================================================================
// UNIFIED ATTACHMENTS - Single table for all file attachments
// ============================================================================

model Attachment {
  id           String               @id @default(cuid())
  entityType   AttachmentEntityType @default(COMPLAINT)
  entityId     String // Generic entity ID (complaint, user, etc.)
  complaintId  String? // Specific complaint reference for backward compatibility
  fileName     String
  originalName String
  mimeType     String
  size         Int
  url          String
  description  String? // Optional description of the attachment
  createdAt    DateTime             @default(now())
  uploadedById String?

  // Relations
  complaint  Complaint? @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  uploadedBy User?      @relation("AttachmentUploadedBy", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([fileName])
  @@index([complaintId])
  @@index([uploadedById])
  @@index([createdAt])
  @@map("attachments")
}

// ============================================================================
// AUTHENTICATION & SECURITY
// ============================================================================

model OTPSession {
  id          String    @id @default(cuid())
  userId      String?
  email       String
  phoneNumber String?
  otpCode     String
  purpose     String    @default("GUEST_VERIFICATION") // GUEST_VERIFICATION, PASSWORD_RESET, etc.
  isVerified  Boolean   @default(false)
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  verifiedAt  DateTime?

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, purpose, isVerified])
  @@index([expiresAt])
  @@index([userId])
  @@index([otpCode])
  @@map("otp_sessions")
}

// ============================================================================
// NOTIFICATIONS - In-app notification system
// ============================================================================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  complaintId String?
  type        String   @default("IN_APP") // IN_APP, EMAIL, SMS
  title       String
  message     String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  complaint Complaint? @relation(fields: [complaintId], references: [id], onDelete: SetNull)

  @@index([userId, isRead])
  @@index([createdAt])
  @@index([complaintId])
  @@map("notifications")
}

// ============================================================================
// SYSTEM CONFIGURATION & ADMINISTRATION
// ============================================================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String? // Type to categorize the setting (e.g., 'app', 'complaint', 'contact', 'system')
  description String?
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt

  @@index([key, isActive])
  @@index([type])
  @@map("system_config")
}
